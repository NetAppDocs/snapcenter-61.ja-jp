---
permalink: protect-sco/task_clone_an_oracle_database_backup.html 
sidebar: sidebar 
keywords: Credentials, alternate host, clone, FRA, OMF 
summary: SnapCenterを使用すると、データベースのバックアップ機能でOracleデータベースをクローニングできます。 
---
= Oracleデータベース バックアップのクローニング
:allow-uri-read: 
:icons: font
:imagesdir: ../media/


[role="lead"]
SnapCenterを使用すると、データベースのバックアップ機能でOracleデータベースをクローニングできます。

*始める前に*

root以外のユーザとしてプラグインをインストールした場合は、実行権限をプリスクリプト ディレクトリとポストスクリプト ディレクトリに手動で割り当てる必要があります。

*このタスクについて*

* クローニング処理では、データベースのデータ ファイルのコピーが作成され、新しいオンラインRedoログ ファイルと制御ファイルが作成されます。データベースは、指定したリカバリ オプションに基づいて、指定した時間にリカバリすることもできます。
+

NOTE: Linuxホストで作成されたバックアップをAIXホストにクローニングしようとすると、クローニングは失敗します。逆の場合も同様です。

+
SnapCenterでは、Oracle RACデータベース バックアップからクローニングすると、スタンドアロン データベースが作成されます。SnapCenterでは、Data Guardスタンバイ データベースおよびActive Data Guardスタンバイ データベースのバックアップからのクローンの作成がサポートされています。

+
クローニング中、SnapCenterでは、リカバリ処理のSCNまたは日時に基づいて、最適な数のログ バックアップがマウントされます。リカバリが完了すると、ログ バックアップはアンマウントされます。このようなクローンすべては、_/var/opt/snapcenter/scu/clones/_ の下にマウントされます。  NFS 経由で ASM を使用している場合は、asm_diskstring パラメータで定義されている既存のパスに _/var/opt/snapcenter/scu/clones/*/*_ を追加する必要があります。

+
SAN 環境で ASM データベースのバックアップをクローン作成するときに、クローン作成されたホスト デバイスの udev ルールが _/etc/udev/rules.d/999-scu-netapp.rules_ に作成されます。クローニングされるホスト デバイスに関連付けられたudevルールは、クローンを削除すると削除されます。

+

NOTE: Flex ASMセットアップでは、カーディナリティがRACクラスタ内のノード数より少ない場合、リーフ ノードではクローニング処理を実行できません。

* SnapLockが有効なポリシーの場合、ONTAP 9.12.1以前のバージョンでは、Snapshotのロック期間を指定すると、リストアの一環として改ざん防止Snapshotから作成されたクローンにSnapLockの有効期限が継承されます。SnapLockの有効期限が過ぎたあと、ストレージ管理者がクローンを手動でクリーンアップする必要があります。


.手順
. 左側のナビゲーション ペインで [*リソース*] をクリックし、リストから適切なプラグインを選択します。
. [リソース] ページで、[表示] リストから [データベース] または [リソース グループ] を選択します。
. データベースの詳細ビューまたはリソース グループの詳細ビューでデータベースを選択します。
+
データベース トポロジのページが表示されます。

. [Manage Copies]ビューで、ローカル コピー（プライマリ）、ミラー コピー（セカンダリ）、バックアップ コピー（セカンダリ）のいずれかのバックアップを選択します。
. 表からデータバックアップを選択し、*をクリックします。image:../media/clone_icon.gif["クローンアイコン"] *。
. [Name]ページで、次のいずれかを実行します。
+
|===
| 状況 | 手順 


 a| 
データベースのクローニング（CDBまたは非CDB）
 a| 
.. クローンのSIDを指定します。
+
クローンSIDはデフォルトでは使用できず、SIDの最大長は8文字です。

+

NOTE: クローンが作成されるホストに、同じSIDのデータベースが存在しないことを確認してください。





 a| 
プラガブル データベース（PDB）のクローニング
 a| 
.. *PDB クローン*を選択します。
.. クローニングするPDBを指定します。
.. クローニングされたPDBの名前を指定します。PDBのクローンを作成する詳細な手順については、link:../protect-sco/task_clone_a_pluggable_database.html["プラガブル データベースのクローニング"^] 。


|===
+
ミラー データまたはバックアップ データを選択する場合、以下のようになります。

+
** ミラーまたはバックアップにログ バックアップが存在しない場合は、何も選択されず、ロケータは空になります。
** ミラーまたはバックアップにログ バックアップが存在する場合は、最新のログ バックアップが選択され、対応するロケータが表示されます。
+

NOTE: 選択したログ バックアップがミラーとバックアップの両方の場所に存在する場合は、両方のロケータが表示されます。



. [Locations]ページで、次の操作を実行します。
+
|===
| フィールド | 操作 


 a| 
Clone host
 a| 
ソース データベース ホストがデフォルトで入力されています。

代替ホストにクローンを作成する場合は、ソース データベース ホストと同じバージョンのOracleおよびOSがインストールされているホストを選択します。



 a| 
Datafile locations
 a| 
データ ファイルの場所がデフォルトで入力されています。

SANファイルシステムまたはNFSファイルシステムのSnapCenterのデフォルトの命名規則は、FileSystemNameofsourcedatabase_CLONESIDです。

SnapCenterで設定されているASMディスク グループのデフォルトの命名規則は、SC_HASHCODEofDISKGROUP_CLONESIDです。HASHCODEofDISKGROUPは、自動生成される2～10桁の数値で、各ASMディスク グループに固有です。


NOTE: ASMディスク グループ名をカスタマイズする場合は、名前の長さがOracleでサポートされる最大長に準拠していることを確認してください。

別のパスを指定する場合は、クローン データベースのデータファイル マウント ポイントまたはASMディスク グループ名を入力する必要があります。データ ファイル パスをカスタマイズする場合は、制御ファイルおよびRedoログ ファイルのASMディスク グループ名またはファイルシステムも、データ ファイルに使用されているのと同じ名前か、既存のASMディスク グループまたはファイルシステムに変更する必要があります。



 a| 
Control files
 a| 
制御ファイルのパスがデフォルトで入力されています。

制御ファイルは、データ ファイルと同じASMディスク グループまたはファイルシステムに配置されます。制御ファイルのパスは、別の制御ファイルのパスを指定して上書きできます。


NOTE: ファイルシステムまたはASMディスク グループがホストに存在している必要があります。

デフォルトでは、制御ファイルの数はソース データベースの数と同じです。制御ファイルの数は変更できますが、データベースをクローニングするには少なくとも1つの制御ファイルが必要です。

制御ファイルのパスは、ソース データベースで設定したものとは別のファイルシステム（既存のファイルシステム）にカスタマイズできます。



 a| 
Redo logs
 a| 
redoログ ファイル グループ、パス、およびサイズがデフォルトで入力されています。

Redoログは、クローン データベースのデータ ファイルと同じASMディスク グループまたはファイルシステムに配置されます。Redoログ ファイルのパスを上書きする場合は、Redoログ ファイルのパスをソース データベースで設定したものとは別のファイルシステムにカスタマイズできます。


NOTE: 新しいファイルシステムまたはASMディスク グループがホストに存在している必要があります。

デフォルトでは、Redoログ グループとRedoログ ファイルの数とサイズはソース データベースと同じです。次のパラメータを変更できます。

** REDOロググループの数



NOTE: データベースをクローニングするには、少なくとも2つのRedoログ グループが必要です。

** 各グループ内のREDOログファイルとそのパス
+
Redoログ ファイルのパスは、ソース データベースで設定したものとは別のファイルシステム（既存のファイルシステム）にカスタマイズできます。




NOTE: データベースをクローニングするには、Redoログ グループに少なくとも1つのRedoログ ファイルが必要です。

** REDOログファイルのサイズ


|===
. [Credentials]ページで、次の操作を実行します。
+
|===
| フィールド | 操作 


 a| 
sysユーザーの資格情報名
 a| 
クローン データベースの sys ユーザ パスワードの定義に使用するクレデンシャルを選択します。

ターゲット ホストの sqlnet.ora ファイルで SQLNET.AUTHENTICATION_SERVICES が NONE に設定されている場合、 SnapCenter GUI で資格情報として *None* を選択しないでください。



 a| 
ASM Instance Credential name
 a| 
クローン ホスト上の ASM インスタンスに接続するために OS 認証が有効になっている場合は、[*なし*] を選択します。

それ以外の場合は、「`sys`」ユーザーまたはクローン ホストに適用可能な「`sysasm`」権限を持つユーザーで構成された Oracle ASM 資格情報を選択します。

|===
+
Oracleホーム、ユーザ名、およびグループの詳細が、ソース データベースから自動的に入力されます。値は、クローンが作成されるホストのOracle環境に基づいて変更できます。

. [PreOps]ページで、次の手順を実行します。
+
.. クローニング処理の前に実行するプリスクリプトのパスと引数を入力します。
+
プレスクリプトは、_/var/opt/snapcenter/spl/scripts_ またはこのパス内の任意のフォルダーに保存する必要があります。デフォルトでは、_/var/opt/snapcenter/spl/scripts_ パスが設定されます。スクリプトをこのパス内の任意のフォルダに配置した場合は、スクリプトの配置先となるフォルダまでの完全なパスを指定する必要があります。

+
SnapCenter、事前スクリプトと事後スクリプトを実行するときに、事前定義された環境変数を使用できます。link:../protect-sco/predefined-environment-variables-prescript-postscript-clone.html["詳細情報"^]

.. [Database Parameter settings]セクションで、データベースの初期化に使用される事前入力されたデータベース パラメータの値を変更します。
+
*をクリックすると追加のパラメータを追加できますimage:../media/add_policy_from_resourcegroup.gif["ポリシーフォームリソースグループを追加する"]*。

+
Oracle Standard Editionを使用しており、データベースがアーカイブ ログ モードで実行されている場合、またはアーカイブRedoログからデータベースをリストアする場合は、パラメータを追加してパスを指定します。

+
*** ログアーカイブ先
*** ログ_アーカイブ_デュプレックス_宛先
+

NOTE: 入力済みのデータベース パラメータでは、高速リカバリ領域（FRA）は定義されていません。FRAを設定するには、関連パラメータを追加します。

+

NOTE: log_archive_dest_1のデフォルト値は$ORACLE_HOME/clone_sidで、この場所にクローン データベースのアーカイブ ログが作成されます。log_archive_dest_1パラメータを削除した場合は、Oracleによってアーカイブ ログの場所が決定されます。Log_archive_dest_1を編集することでアーカイブ ログの新しい場所を定義できますが、その際はファイルシステムまたはディスク グループが存在し、ホスト上で使用可能になっていることを確認してください。



.. *リセット*をクリックすると、デフォルトのデータベース パラメータ設定が取得されます。


. PostOps ページでは、クローンされたデータベースの回復を実行するために、*データベースの回復* と *キャンセルまで* がデフォルトで選択されています。
+
SnapCenterは、クローニング対象として選択されたデータ バックアップのあとに、破損していない一連のアーカイブ ログを含む最新のログ バックアップをマウントすることでリカバリを実行します。プライマリ ストレージでクローニングを実行するには、ログとデータのバックアップをプライマリ ストレージに配置し、セカンダリ ストレージでクローニングを実行するには、ログとデータのバックアップをセカンダリ ストレージに配置する必要があります。

+
SnapCenter が適切なログ バックアップを見つけられない場合は、*データベースの回復* および *キャンセルまで* オプションは選択されません。 *外部アーカイブ ログの場所の指定*でログ バックアップが利用できない場合は、外部アーカイブ ログの場所を指定できます。ログの場所は複数指定できます。

+

NOTE: フラッシュ リカバリ領域（FRA）とOracle Managed Files（OMF）をサポートするように設定されているソース データベースをクローニングする場合は、リカバリのログ デスティネーションもOMFディレクトリ構造に従っている必要があります。

+
ソース データベースがData Guardスタンバイ データベースまたはActive Data Guardスタンバイ データベースの場合、[PostOps]ページは表示されません。Data Guardスタンバイ データベースまたはActive Data Guardスタンバイ データベースの場合、SnapCenterにはSnapCenter GUIでリカバリ タイプを選択するオプションはありませんが、ログを適用せずに[Cancel]リカバリ タイプを使用してデータベースをリカバリします。

+
|===
| フィールド名 | 説明 


 a| 
キャンセルまで
 a| 
SnapCenterは、クローニング対象として選択されたデータ バックアップのあとに、破損していない一連のアーカイブ ログを含む最新のログ バックアップをマウントすることでリカバリを実行します。クローン データベースは、欠落または破損したログ ファイルまでリカバリされます。



 a| 
Date and time
 a| 
SnapCenterは、指定された日時までデータベースをリカバリします。有効な形式はmm/dd/yyyy hh:mm:ssです。


NOTE: 時刻は24時間形式で指定できます。



 a| 
Until SCN (System Change Number)
 a| 
SnapCenterは、指定されたシステム変更番号（SCN）までデータベースをリカバリします。



 a| 
Specify external archive log locations
 a| 
データベースがARCHIVELOGモードで実行されている場合、SnapCenterは指定したSCNまたは選択した日時に基づいて、最適な数のログ バックアップを識別してマウントします。

外部アーカイブ ログの場所を指定することもできます。


NOTE: [Until Cancel]を選択した場合、SnapCenterがログ バックアップを自動的に識別してマウントすることはありません。



 a| 
新しいDBIDを作成する
 a| 
デフォルトでは、*新しい DBID の作成* チェックボックスが選択されており、クローンされたデータベースとソース データベースを区別する一意の番号 (DBID) が生成されます。

ソース データベースのDBIDをクローン データベースに割り当てる場合は、このチェック ボックスをオフにします。このシナリオでは、ソース データベースがすでに登録されている外部のRMANカタログにクローン データベースを登録すると、処理は失敗します。



 a| 
一時表領域用の一時ファイルを作成する
 a| 
クローン データベースのデフォルトの一時表領域用の一時ファイルを作成する場合は、このチェック ボックスを選択します。

このチェック ボックスをオフにすると、一時ファイルなしでデータベース クローンが作成されます。



 a| 
Enter sql entries to apply when clone is created
 a| 
クローンの作成時に適用するSQLエントリを追加します。



 a| 
Enter scripts to run after clone operation
 a| 
クローニング処理のあとに実行するポストスクリプトのパスと引数を指定します。

ポストスクリプトは、_/var/opt/snapcenter/spl/scripts_ またはこのパス内の任意のフォルダーに保存する必要があります。デフォルトでは、_/var/opt/snapcenter/spl/scripts_ パスが設定されます。

スクリプトをこのパス内の任意のフォルダに配置した場合は、スクリプトの配置先となるフォルダまでの完全なパスを指定する必要があります。


NOTE: クローニング処理が失敗した場合、ポストスクリプトは実行されず、クリーンアップ アクティビティが直接トリガーされます。

|===
. 通知ページの *電子メール設定* ドロップダウン リストから、電子メールを送信するシナリオを選択します。
+
また、送信者と受信者のEメール アドレス、およびEメールの件名を指定する必要があります。実行されたクローン操作のレポートを添付する場合は、「*ジョブ レポートの添付*」を選択します。

+

NOTE: Eメール通知を利用する場合は、GUIまたはPowerShellのSet-SmSmtpServerコマンドを使用して、SMTPサーバの詳細を指定しておく必要があります。

. 概要を確認し、[完了] をクリックします。
+

NOTE: クローニング処理の一環としてリカバリを実行する場合は、リカバリが失敗してもクローンが作成され、警告が表示されます。このクローンに対して手動リカバリを実行することで、クローン データベースの整合性を確保できます。

. *モニター* > *ジョブ* をクリックして、操作の進行状況を監視します。


*結果*

データベースをクローニングしたあとにリソース ページを更新すると、クローン データベースが、バックアップ対象のリソースの1つとしてリストに追加されます。クローニングされたデータベースは、標準のバックアップ ワークフローを使用して他のデータベースと同様に保護することも、リソース グループ（新規または既存）に含めることもできます。クローニングされたデータベースは、さらにクローニングすることができます（クローンのクローン）。

クローニング後は、クローン データベースの名前を変更しないでください。


NOTE: クローニング中にリカバリを実行しなかった場合は、不適切なリカバリが原因でクローン データベースのバックアップが失敗して、手動でのリカバリが必要になることがあります。また、アーカイブ ログ用に設定されていたデフォルトの場所がNetApp以外のストレージにある場合や、ストレージ システムでSnapCenterが設定されていない場合も、ログのバックアップは失敗することがあります。

AIXのセットアップでは、lkdevコマンドを使用して、クローン データベースが配置されているディスクをロックし、rendevコマンドを使用してディスク名を変更することができます。

デバイスをロックまたは名前変更しても、クローンの削除処理には影響しません。SANデバイス上に構築されたAIX LVMレイアウトでは、クローニングされたSANデバイスのデバイス名の変更はサポートされません。

*詳細情報*

* https://kb.netapp.com/Advice_and_Troubleshooting/Data_Protection_and_Security/SnapCenter/ORA-00308%3A_cannot_open_archived_log_ORA_LOG_arch1_123_456789012.arc["ORA-00308 エラーメッセージが表示され、復元またはクローン作成が失敗する"^]
* https://kb.netapp.com/Advice_and_Troubleshooting/Data_Protection_and_Security/SnapCenter/Failed_to_recover_a_cloned_database["クローンデータベースの回復に失敗しました"^]
* https://kb.netapp.com/Advice_and_Troubleshooting/Data_Protection_and_Security/SnapCenter/What_are_the_customizable_parameters_for_backup_restore_and_clone_operations_on_AIX_systems["AIX システムでのバックアップ、復元、クローン操作のカスタマイズ可能なパラメータ"^]




== ホストの優先IPを更新する

クローン操作が完了すると、ストレージ アクセス レイヤー (SAL) によってクローンに提供されるパスは、_<nfs_lif_IP>:<JunctionPath>_ 形式になります。優先 IP を提供するには、SCCLI コマンドを使用してホスト上で設定する必要があります。

.手順
. データベース ホストにログインします。
. 指定されたユーザーに対して、 SnapCenterとの PowerShell 接続セッションを開始します。
+
Open-SmConnection

. 空のファイルを作成します。
+
/var/opt/snapcenter/scu/etc/storagepreference.properties をタッチします。

. SVM の優先データ LIF を設定します。
+
Add-SvmPreferredDataPath -SVM <SVM 名> -DataPath <IP アドレスまたは FQDN>

. 優先パスを確認します。
+
Get-SvmPreferredDataPath


